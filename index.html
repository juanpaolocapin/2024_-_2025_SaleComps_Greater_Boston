<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>2024‚Äì2025 Apartment Sale Comps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet" />

  <style>
    html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; }
    #map { position:absolute; width:100%; height:100%; }

    .map-title { position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.6); color:white; padding:6px 12px; font-size:18px;
      border-radius:4px; z-index:2; }

    .map-note { position:absolute; bottom:36px; left:10px;
      background:rgba(255,255,255,0.8); padding:2px 8px; font-size:11px;
      border-radius:3px; z-index:2; }

    .control-stack { position:absolute; top:20px; left:10px;
      display:flex; flex-direction:column; gap:10px; z-index:3; max-width:360px; }

    .control-box { background:rgba(255,255,255,0.7); padding:8px; font-size:13px;
      border-radius:5px; box-shadow:0 0 8px rgba(0,0,0,0.2); }

    .basemap-switcher button { background:none; border:none; padding:5px 10px; cursor:pointer; }
    .basemap-switcher button.active { font-weight:bold; text-decoration:underline; }

    .filter-legend-box .header-row,
    .filter-legend-box .row {
      display: grid;
      grid-template-columns: 22px 18px 1fr 90px;
      align-items: center;
      gap: 6px;
    }
    .filter-legend-box .header-row {
      font-weight:bold;
      border-bottom:1px solid #ccc;
      margin-bottom:6px;
      padding-bottom:4px;
    }
    .filter-legend-box .row { margin-bottom:6px; }
    .filter-legend-box input { margin:0; }
    .filter-legend-box svg { width:14px; height:14px; }
    .filter-legend-box .status-text { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .filter-legend-box .units { text-align:right; font-variant-numeric:tabular-nums; }

    .mapboxgl-ctrl-geocoder { min-width:250px; margin:10px; }
    .mapboxgl-ctrl-top-right .mapboxgl-ctrl-geocoder { margin:10px; }

    /* Detail panel on RIGHT */
    .detail-panel {
      position:absolute;
      top:50%;
      right:-420px;
      transform:translateY(-50%);
      background:white;
      padding:12px;
      width:400px;
      border-radius:5px;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
      font-size:13px;
      overflow-y:auto;
      max-height:80%;
      z-index:3;
      transition:right 0.35s ease;
    }
    .detail-panel.visible { right:10px; }

    .detail-header { display:flex; justify-content:space-between; align-items:center;
      font-weight:bold; font-size:15px; margin-bottom:10px; }
    .close-btn { background:none; border:none; font-size:18px; cursor:pointer; color:#666; }
    .detail-panel hr { margin:8px 0; }

    .control-box select{
      width: 100%;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.85);
    }

    .notes-box{
      white-space: pre-wrap;
      background: #f6f6f6;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 8px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="map-title">2024‚Äì2025 Apartment Sale Comps</div>
  <div class="map-note">Created for Marcus Partners</div>

  <div class="control-stack">
    <div class="control-box basemap-switcher">
      <div><strong>Theme</strong></div>
      <button id="lightBtn">Light</button>
      <button id="darkBtn" class="active">Dark</button>
    </div>

    <div class="control-box">
      <div><strong>Filter (No / Property Name)</strong></div>
      <select id="recordFilter">
        <option value="">All</option>
      </select>
    </div>

    <div class="control-box">
      <div><strong>Marker label</strong></div>
      <select id="labelField">
        <option value="Cap Rate (%)">Cap Rate (%)</option>
        <option value="No">No</option>
        <option value="Units">Units</option>
      </select>
    </div>

    <div class="control-box filter-legend-box" id="filterLegend">
      <div class="header-row">
        <div></div><div></div>
        <div>Sale Year</div>
        <div class="units">Units</div>
      </div>
      <div id="debugStatus" style="margin-top:6px; font-size:11px; color:#444;"></div>
    </div>
  </div>

  <div class="detail-panel" id="propertyDetail">
    <div class="detail-header">
      Comp Details
      <button class="close-btn" onclick="hideDetailPanel()">‚úñ</button>
    </div>
    <div id="propertyDetailContent"></div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoianVhbjEyMjciLCJhIjoiY2tvMmlhZ3FlMDZuYjJubzdlanZlY3A5dSJ9.b0Q5WdIxWsWFXnhzm77m5w';

    const SHEET_ID = "1cSpplIIJ0JvQRJ4uQaLXSy3m060fy_NifKR3PKHNZ5E";
    const TAB_NAME = "Sheet1";
    const SHEET_URL = `https://opensheet.elk.sh/${SHEET_ID}/${TAB_NAME}`;

    const MARKER_PX = 30;

    const FIT_PADDING = 120;
    const FIT_MAX_ZOOM = 14.25;
    const FIT_DURATION = 650;

    const yearColors = { "2024": "#2b83ba", "2025": "#d7191c" };

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [-71.1, 42.36],
      zoom: 10
    });

    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl,
      marker:false,
      placeholder:"Search address or place"
    });
    map.addControl(geocoder, 'top-right');

    let searchMarker=null, searchPopup=null;
    geocoder.on('result', e => {
      const { center, place_name } = e.result;
      if (searchMarker) searchMarker.remove();
      if (searchPopup) searchPopup.remove();
      searchMarker = new mapboxgl.Marker({ color: 'blue' }).setLngLat(center).addTo(map);
      searchPopup = new mapboxgl.Popup({ offset: 25 }).setLngLat(center).setHTML(`<strong>${place_name}</strong>`).addTo(map);
    });
    map.on('click', () => {
      if (searchMarker) searchMarker.remove();
      if (searchPopup) searchPopup.remove();
      searchMarker=null; searchPopup=null;
    });

    let allData = [];
    let projectMarkers = [];
    let labelField = "Cap Rate (%)";
    let recordFilterValue = "";

    const LINES_SOURCE_ID = "leader-lines";
    const LINES_LAYER_ID  = "leader-lines";

    document.getElementById("lightBtn").onclick = ()=> switchStyle("mapbox://styles/mapbox/light-v11", "lightBtn");
    document.getElementById("darkBtn").onclick  = ()=> switchStyle("mapbox://styles/mapbox/dark-v11", "darkBtn");

    function setActive(id){
      document.querySelectorAll('.basemap-switcher button').forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    function switchStyle(styleUrl, activeBtnId){
      map.setStyle(styleUrl);
      setActive(activeBtnId);
      map.once("style.load", () => renderProjectMarkers(false));
    }

    document.getElementById("labelField").value = "Cap Rate (%)";
    document.getElementById("labelField").addEventListener("change", e => {
      labelField = e.target.value;
      renderProjectMarkers(false);
    });

    document.getElementById("recordFilter").addEventListener("change", e => {
      recordFilterValue = e.target.value;
      renderProjectMarkers(true);
    });

    function setDebug(msg){ document.getElementById("debugStatus").textContent = msg; }

    function normalizeRowKeys(row){
      const out = {};
      for (const [k, v] of Object.entries(row)){
        const nk = String(k).trim();
        out[nk] = v;
        out[nk.toLowerCase()] = v;
      }
      return out;
    }

    function toNumber(v){
      if (v === null || v === undefined) return NaN;
      const s = String(v).trim().replace(/[$,]/g,"");
      const cleaned = s.replace(/[^\d\.\-]/g, "");
      return parseFloat(cleaned);
    }

    function detectCoordKeys(sampleRow){
      const keys = Object.keys(sampleRow || {});
      const lowerKeys = keys.map(k => k.toLowerCase());
      const latCandidates = ["lat", "latitude"];
      const lonCandidates = ["long", "lon", "lng", "longitude"];
      const latKey = lowerKeys.find(k => latCandidates.includes(k)) || lowerKeys.find(k => k.includes("lat"));
      const lonKey = lowerKeys.find(k => lonCandidates.includes(k)) || lowerKeys.find(k => k.includes("lon") || k.includes("lng") || k.includes("long"));
      return { latKey, lonKey };
    }

    function normalizeYear(v){
      const n = Math.round(toNumber(v));
      if (n === 2024 || n === 2025) return String(n);
      const s = (v ?? "").toString().trim();
      if (s.includes("2024")) return "2024";
      if (s.includes("2025")) return "2025";
      return "Unknown";
    }

    function fmtMoney(v){
      const n = toNumber(v);
      if(!isFinite(n)) return "";
      return n.toLocaleString(undefined,{maximumFractionDigits:0});
    }
    function fmtNumber(v){
      const n = toNumber(v);
      if(!isFinite(n)) return "";
      return n.toLocaleString();
    }
    function fmtPct(v){
      const n = toNumber(v);
      if(!isFinite(n)) return "?";
      const pct = (n > 0 && n < 1) ? (n * 100) : n;
      return pct.toFixed(2) + "%";
    }

    function escapeXml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&apos;");
    }

    // NEW: read boolean-ish column and show Yes/No
    function toYesNo(v){
      if (v === null || v === undefined) return "No";
      const s = String(v).trim().toLowerCase();
      if (!s) return "No";
      if (["yes","y","true","1","t"].includes(s)) return "Yes";
      if (["no","n","false","0","f"].includes(s)) return "No";
      // fallback: if it contains yes/true -> Yes else No
      if (s.includes("yes") || s.includes("true")) return "Yes";
      return "No";
    }

    function createSvgIcon(label, fill){
      const size = MARKER_PX;
      const stroke = 1.5;
      const r = (size - stroke) / 2;

      let txt = String(label ?? "?").trim();
      if (!txt) txt = "?";
      if (txt.length > 6) txt = txt.slice(0,6);

      const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
        <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="${fill}" stroke="white" stroke-width="${stroke}" />
        <text x="50%" y="52%" text-anchor="middle" dominant-baseline="middle"
              font-size="8" fill="black" font-family="Arial" font-weight="700">
          ${escapeXml(txt)}
        </text>
      </svg>`.trim();

      return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }

    function getRowNo(row){
      return (row["No"] || row["no"] || "").toString().trim();
    }
    function getRowProperty(row){
      return (row["Property Name"] || row["property name"] || "").toString().trim();
    }
    function rowKey(row){
      return `${getRowNo(row)}|${getRowProperty(row)}`;
    }
    function rowMatchesRecordFilter(row){
      if (!recordFilterValue) return true;
      return rowKey(row) === recordFilterValue;
    }

    function populateRecordFilter(){
      const sel = document.getElementById("recordFilter");
      const current = sel.value;

      sel.innerHTML = `<option value="">All</option>`;

      const seen = new Set();
      const options = [];

      allData.forEach(r=>{
        const no = getRowNo(r);
        const prop = getRowProperty(r);
        if(!no && !prop) return;
        const key = `${no}|${prop}`;
        if(seen.has(key)) return;
        seen.add(key);
        const label = `${no ? ("#"+no) : ""}${no && prop ? " - " : ""}${prop}`;
        options.push({ key, label, no });
      });

      options.sort((a,b)=>{
        const an = parseFloat(a.no);
        const bn = parseFloat(b.no);
        const aHas = isFinite(an), bHas = isFinite(bn);
        if(aHas && bHas) return an - bn;
        return a.label.localeCompare(b.label);
      });

      options.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o.key;
        opt.textContent = o.label;
        sel.appendChild(opt);
      });

      if ([...sel.options].some(o=>o.value===current)) sel.value = current;
    }

    async function loadSheet(){
      setDebug("Loading sheet‚Ä¶");

      let raw;
      try{
        const r = await fetch(SHEET_URL, { cache:"no-store" });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        raw = await r.json();
      }catch(err){
        console.error(err);
        setDebug(`Sheet fetch failed (${err.message}).`);
        return;
      }

      if(!raw || !raw.length){
        setDebug("Sheet returned 0 rows.");
        return;
      }

      const normalized = raw.map(normalizeRowKeys);
      const { latKey, lonKey } = detectCoordKeys(normalized[0]);
      if(!latKey || !lonKey){
        setDebug("Could not detect lat/lon columns.");
        return;
      }

      const cleaned = [];
      let bad = 0;

      for(const row of normalized){
        const lat = toNumber(row[latKey]);
        const lon = toNumber(row[lonKey]);
        if(!isFinite(lat) || !isFinite(lon)) { bad++; continue; }

        const saleYear = normalizeYear(row["Sale Year"] || row["sale year"] || row["Sale Date"] || row["sale date"]);
        cleaned.push({
          ...row,
          lat,
          lon,
          saleYear,
          units: toNumber(row["Units"] || row["units"]) || 0
        });
      }

      allData = cleaned;
      setDebug(`Loaded ${raw.length} rows ‚Ä¢ Mapped ${allData.length} points ‚Ä¢ Skipped(no coords) ${bad}`);

      populateRecordFilter();

      const yearsPresent = [...new Set(allData.map(d=>d.saleYear))].filter(Boolean);
      buildYearLegend(yearsPresent);

      renderProjectMarkers(true);
    }

    function buildYearLegend(years){
      const c = document.getElementById('filterLegend');
      c.querySelectorAll('.row').forEach(r => r.remove());

      const totals = {};
      allData.forEach(r=>{
        const y = r.saleYear || "Unknown";
        totals[y] = (totals[y]||0) + (r.units||0);
      });

      const ordered = ["2024","2025", ...years.filter(y => y !== "2024" && y !== "2025")];

      ordered.forEach(y => {
        if(!(y in totals)) return;

        const color = yearColors[y] || "#888";
        const units = totals[y] || 0;

        const row = document.createElement('div');
        row.className = 'row';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'year-filter';
        checkbox.value = y;
        checkbox.checked = true;

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 24 24');
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', 12);
        circle.setAttribute('cy', 12);
        circle.setAttribute('r', 6);
        circle.setAttribute('fill', color);
        svg.appendChild(circle);

        const txt = document.createElement('div');
        txt.className = 'status-text';
        txt.textContent = y;

        const unitsDiv = document.createElement('div');
        unitsDiv.className = 'units';
        unitsDiv.textContent = units.toLocaleString();

        row.appendChild(checkbox);
        row.appendChild(svg);
        row.appendChild(txt);
        row.appendChild(unitsDiv);

        const debug = document.getElementById("debugStatus");
        c.insertBefore(row, debug);
      });

      document.querySelectorAll('.year-filter').forEach(cb => {
        cb.addEventListener('change', () => renderProjectMarkers(false));
      });
    }

    function clearMarkersAndLines(){
      projectMarkers.forEach(m=>m.remove());
      projectMarkers = [];
      if (map.getLayer(LINES_LAYER_ID)) map.removeLayer(LINES_LAYER_ID);
      if (map.getSource(LINES_SOURCE_ID)) map.removeSource(LINES_SOURCE_ID);
    }

    function renderProjectMarkers(fitToBounds){
      if (!map || !map.isStyleLoaded()) {
        map.once("idle", () => renderProjectMarkers(fitToBounds));
        return;
      }

      clearMarkersAndLines();

      const selectedYears = Array.from(document.querySelectorAll('.year-filter:checked')).map(cb=>cb.value);

      const filtered = allData.filter(r =>
        selectedYears.includes(r.saleYear) && rowMatchesRecordFilter(r)
      );

      const mapCoord = {};
      filtered.forEach(r=>{
        const key = `${r.lat},${r.lon}`;
        if(!mapCoord[key]) mapCoord[key]=[];
        mapCoord[key].push(r);
      });

      const bounds = new mapboxgl.LngLatBounds();
      const lines = [];

      Object.entries(mapCoord).forEach(([coord, rows])=>{
        const [lat,lon] = coord.split(',').map(parseFloat);
        bounds.extend([lon,lat]);

        rows.forEach((r,i)=>{
          const offsetDistance = 0.00015;
          const angle = (i * 360 / rows.length) * Math.PI / 180;
          const offsetLon = lon + Math.cos(angle) * offsetDistance * 0.6;
          const offsetLat = lat + Math.sin(angle) * offsetDistance * 1.4;

          const color = yearColors[r.saleYear] || "#888";

          let lbl = r[labelField] ?? r[labelField.toLowerCase()] ?? "";
          if(labelField === "Units") lbl = fmtNumber(lbl);
          if(labelField === "Cap Rate (%)") lbl = fmtPct(lbl);
          if(labelField === "No") lbl = (r["No"] || r["no"] || "").toString().trim() || "?";

          const el = document.createElement('div');
          el.style.backgroundImage = `url('${createSvgIcon(lbl, color)}')`;
          el.style.width = `${MARKER_PX}px`;
          el.style.height = `${MARKER_PX}px`;
          el.style.backgroundSize = 'cover';
          el.style.cursor = 'pointer';
          el.addEventListener('click', () => openDetail(rows));

          const mk = new mapboxgl.Marker(el).setLngLat([offsetLon, offsetLat]).addTo(map);
          projectMarkers.push(mk);

          lines.push({
            type: "Feature",
            geometry: { type: "LineString", coordinates: [[lon, lat],[offsetLon, offsetLat]] },
            properties: {}
          });
        });
      });

      if(fitToBounds && !bounds.isEmpty()){
        map.fitBounds(bounds, {
          padding: FIT_PADDING,
          maxZoom: FIT_MAX_ZOOM,
          duration: FIT_DURATION
        });
      }

      map.addSource(LINES_SOURCE_ID, {
        type: 'geojson',
        data: { type: "FeatureCollection", features: lines }
      });
      map.addLayer({
        id: LINES_LAYER_ID,
        type: 'line',
        source: LINES_SOURCE_ID,
        paint: {
          'line-color': '#aaa',
          'line-width': 1,
          'line-dasharray': [2,2]
        }
      });
    }

    /* =========================
       FIXED UNIT MIX EXTRACTION
       ========================= */
    function pickFirstExistingKey(row, candidates){
      for(const c of candidates){
        const v = row[c];
        if(v !== undefined && v !== null && String(v).trim() !== "") return c;
        const vl = row[String(c).toLowerCase()];
        if(vl !== undefined && vl !== null && String(vl).trim() !== "") return String(c).toLowerCase();
      }
      return null;
    }

    function findKeyByRegex(row, regex){
      const keys = Object.keys(row || {});
      for(const k of keys){
        if(regex.test(String(k))) return k;
      }
      return null;
    }

    function getCountFromRow(row, candidates, fallbackRegex){
      let key = pickFirstExistingKey(row, candidates);
      if(!key && fallbackRegex) key = findKeyByRegex(row, fallbackRegex);
      const val = key ? row[key] : undefined;
      const n = toNumber(val);
      return isFinite(n) ? n : 0;
    }

    function unitMixFromRow(r){
      const studio = getCountFromRow(
        r,
        ["Studio Units", "Studios", "Studio Unit", "Studio"],
        /\bstudio\b.*\bunit/i
      );

      const one = getCountFromRow(
        r,
        ["One-Bedroom Units","One-Bedroom Unit","One Bedroom Units","One Bedroom Unit","1BR Units","1BR Unit","1 Bedroom Units","1 Bedroom Unit","1-Bedroom Units","1-Bedroom Unit"],
        /\bone\b.*bed.*\bunit/i
      );

      const two = getCountFromRow(
        r,
        ["Two-Bedroom Units","Two-Bedroom Unit","Two Bedroom Units","Two Bedroom Unit","2BR Units","2BR Unit","2 Bedroom Units","2 Bedroom Unit","2-Bedroom Units","2-Bedroom Unit"],
        /\btwo\b.*bed.*\bunit/i
      );

      const three = getCountFromRow(
        r,
        ["Three-Bedroom Units","Three-Bedroom Unit","Three Bedroom Units","Three Bedroom Unit","3BR Units","3BR Unit","3 Bedroom Units","3 Bedroom Unit","3-Bedroom Units","3-Bedroom Unit"],
        /\bthree\b.*bed.*\bunit/i
      );

      const four = getCountFromRow(
        r,
        ["Four-Bedroom Units","Four-Bedroom Unit","Four Bedroom Units","Four Bedroom Unit","4BR Units","4BR Unit","4 Bedroom Units","4 Bedroom Unit","4-Bedroom Units","4-Bedroom Unit"],
        /\bfour\b.*bed.*\bunit/i
      );

      const hasAny = (studio + one + two + three + four) > 0;
      if(!hasAny) return "";

      return `${fmtNumber(studio)} Studio | ${fmtNumber(one)} One-BR | ${fmtNumber(two)} Two-BR | ${fmtNumber(three)} Three-BR | ${fmtNumber(four)} Four-BR`;
    }

    function openDetail(rows){
      const content = document.getElementById('propertyDetailContent');
      let html = '';

      if(rows.length > 1){
        html += `<label>Select comp: <select id="selectComp"></select></label><br><hr>`;
      }

      rows.forEach((r,i)=>{
        const salePrice = fmtMoney(r["Sale Price ($)"] || r["sale price ($)"]);
        const ppu = fmtMoney(r["Price per Unit ($)"] || r["price per unit ($)"]);
        const ppsf = fmtMoney(r["Price per SF ($)"] || r["price per sf ($)"]);
        const cap = fmtPct(r["Cap Rate (%)"] || r["cap rate (%)"]);
        const gm = (r["Street View URL"] || r["street view url"] || "").trim();

        const assetClass = (r["Asset Class"] || r["asset class"] || "").toString().trim();
        const assetType = (r["Asset Type"] || r["asset type"] || "").toString().trim();
        const yearBuilt = (r["Year Built"] || r["year built"] || "").toString().trim();
        const buildingType = (r["Building Type"] || r["building type"] || "").toString().trim();
        const affordability = (r["Affordability"] || r["affordability"] || "").toString().trim();

        // existing cap basis logic retained
        let capBasis = (r["Cap Rate Basis"] || r["cap rate basis"] || "").toString().trim();
        const taxAdjRawOld = (r["Tax Adjusted"] || r["tax adjusted"] || r["Tax-Adjusted"] || r["tax-adjusted"] || "").toString().trim();
        const isTaxAdjustedOld = /tax\s*adjust/i.test(capBasis) || /tax\s*adjust/i.test(taxAdjRawOld) || taxAdjRawOld.toLowerCase()==="yes" || taxAdjRawOld.toLowerCase()==="true";
        if(capBasis){
          if(isTaxAdjustedOld && !/tax\s*adjust/i.test(capBasis)) capBasis = `${capBasis} (Tax Adjusted)`;
        } else {
          if(isTaxAdjustedOld) capBasis = "Tax Adjusted";
        }

        // NEW: explicit Yes/No based on "Tax Adjusted?"
        const taxAdjustedYesNo = toYesNo(r["Tax Adjusted?"] || r["tax adjusted?"] || r["Tax Adjusted ?"] || r["tax adjusted ?"]);

        const notes = (r["Notes"] || r["notes"] || "").toString().trim();
        const unitMix = unitMixFromRow(r);

        const optLine = (icon, label, val) => val ? `${icon} <b>${label}:</b> ${escapeXml(val)}<br>` : "";

        html += `<div class="comp-info" data-index="${i}" style="display:${i===0?'block':'none'}">
          <b>#:</b> ${escapeXml((r["No"] || r["no"] || "") + "")}<br>
          üè¢ <b>Property:</b> ${escapeXml((r["Property Name"] || r["property name"] || "") + "")}<br>
          üìç <b>Address:</b> ${escapeXml((r["Full Street Address"] || r["full street address"] || "") + "")}<br>
          ${optLine("üè∑Ô∏è","Asset Class", assetClass)}
          ${optLine("üßæ","Asset Type", assetType)}
          ${optLine("üèóÔ∏è","Building Type", buildingType)}
          ${optLine("üìÜ","Year Built", yearBuilt)}
          üßÆ <b>Units:</b> ${fmtNumber(r["Units"] || r["units"])}<br>
          ${unitMix ? `üß© <b>Unit Mix:</b> ${escapeXml(unitMix)}<br>` : ``}
          ${affordability ? `üè† <b>Affordability:</b> ${escapeXml(affordability)}<br>` : ``}
          <hr>
          üí∞ <b>Sale Date:</b> ${escapeXml((r["Sale Date"] || r["sale date"] || "") + "")}<br>
          üíµ <b>Sale Price ($):</b> ${salePrice}<br>
          üí≤ <b>Price per Unit ($):</b> ${ppu}<br>
          üìè <b>Price per SF ($):</b> ${ppsf}<br>
          üìâ <b>Cap Rate (%):</b> ${cap}<br>
          ${capBasis ? `üß† <b>Cap Rate Basis:</b> ${escapeXml(capBasis)}<br>` : ``}
          üßæ <b>Tax Adjusted?:</b> ${taxAdjustedYesNo}<br>
          <hr>
          ü§ù <b>Buyer:</b> ${escapeXml((r["Buyer"] || r["buyer"] || "") + "")}<br>
          üè∑Ô∏è <b>Seller:</b> ${escapeXml((r["Seller"] || r["seller"] || "") + "")}<br>
          ${notes ? `<hr><b>üìù Notes:</b><div class="notes-box">${escapeXml(notes)}</div>` : ``}
          ${gm ? `<hr>üîó <a href="${gm}" target="_blank" rel="noopener">Open in Google Map</a>` : ``}
        </div>`;
      });

      content.innerHTML = html;

      if(rows.length > 1){
        const sel = document.getElementById('selectComp');
        rows.forEach((r,i)=> sel.add(new Option(`${(r["No"]||r["no"]||i+1)} - ${(r["Property Name"]||r["property name"]||"Comp")}`, i)));
        sel.addEventListener('change',()=>{
          const idx = parseInt(sel.value,10);
          content.querySelectorAll('.comp-info').forEach(div=>{
            div.style.display = (parseInt(div.getAttribute('data-index'),10)===idx) ? 'block' : 'none';
          });
        });
      }

      document.getElementById('propertyDetail').classList.add('visible');
    }

    function hideDetailPanel(){
      document.getElementById('propertyDetail').classList.remove('visible');
    }

    map.on("load", loadSheet);
  </script>
</body>
</html>
